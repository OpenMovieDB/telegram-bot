# Анализ логики оплаты и системы скидок

## Обзор системы

Система оплаты в телеграм-боте Kinopoisk API реализует полный цикл обработки платежей с поддержкой нескольких платежных систем и системы скидок при смене тарифа.

## Компоненты системы

### 1. PaymentService (`src/payment/payment.service.ts`)

Основной сервис управления платежами:

#### Метод `createPayment`
- **Входные данные**: userId, chatId, tariffId, paymentSystem, paymentMonths, email
- **Логика скидок**:
  - Проверяет наличие активной подписки
  - При смене тарифа рассчитывает скидку за неиспользованные дни текущего тарифа
  - Формула скидки: `(цена_текущего_тарифа / 30) * оставшиеся_дни`
  - Применяет скидку к итоговой стоимости
- **Важно**: user.tariffId после populate является объектом Tariff, не строкой

#### Метод `validatePayment`
- Проверяет статус платежа через соответствующую платежную систему
- При успешной оплате:
  - Очищает кеш Redis для токена пользователя
  - Применяет новый тариф немедленно (без отложенной активации)
  - Обновляет даты подписки и обнуляет счетчик использованных запросов

### 2. Payment Schema (`src/payment/schemas/payment.schema.ts`)

Схема платежа включает:
- **discount**: размер примененной скидки
- **originalPrice**: полная стоимость без скидки
- **amount**: итоговая сумма к оплате
- **paymentId**, **orderId**: идентификаторы платежа
- **status**: статус платежа (PENDING, PAID, FAILED и т.д.)
- **paymentSystem**: используемая платежная система

### 3. PaymentScene (`src/scenes/payment.scene.ts`)

Сцена взаимодействия с пользователем:
- Отображает детальную информацию о скидке при смене тарифа
- Показывает переход между тарифами
- Выводит количество оставшихся дней текущей подписки
- **Исправлено**: user.tariffId уже является объектом Tariff после populate

### 4. PaymentScheduler (`src/payment/payment.scheduler.ts`)

Фоновые задачи:
- **handlePendingPayments** (каждые 10 секунд): проверяет статус ожидающих платежей
- **handleExpiredSubscription** (каждые 5 часов): обрабатывает истекшие подписки
- **Удалено**: логика отложенного применения тарифов (pendingTariffId)

### 5. Платежные стратегии

Каждая платежная система реализует интерфейс `IPaymentStrategy`:
- **CryptomusPaymentStrategy**: криптовалютные платежи
- **TBankPaymentStrategy**: банковские платежи через Тинькофф
- **YooKassaPaymentStrategy**: платежи через ЮKassa
- **YooMoneyPaymentStrategy**: платежи через ЮMoney
- **WalletPaymentStrategy**: платежи через Wallet

## Поток обработки платежа

### 1. Создание платежа
```
Пользователь выбирает тариф → PaymentScene → PaymentService.createPayment
                                                  ↓
                                          Расчет скидки (если есть)
                                                  ↓
                                          PaymentStrategy.createPayment
                                                  ↓
                                          Сохранение в БД со статусом PENDING
                                                  ↓
                                          Отправка ссылки на оплату пользователю
```

### 2. Обработка оплаты
```
PaymentScheduler.handlePendingPayments → PaymentService.validatePayment
                                                  ↓
                                          PaymentStrategy.validateTransaction
                                                  ↓
                                          Если оплачено:
                                            - Обновление статуса платежа
                                            - Применение тарифа
                                            - Обновление дат подписки
                                            - Очистка кеша Redis
                                            - Уведомления пользователю и админу
```

## Система скидок

### Правила смены тарифа:

#### Повышение тарифа (Upgrade):
- Разрешено в любое время
- Применяется скидка за неиспользованные дни текущего тарифа
- Новый тариф активируется немедленно

#### Понижение тарифа (Downgrade):
- **Запрещено** во время действия активной подписки
- **Разрешено** только в день истечения текущей подписки или после
- При попытке понижения показывается сообщение с указанием даты, когда это будет возможно
- При понижении в день истечения скидка не применяется

### Расчет скидки (только для повышения тарифа):
- Определяется количество оставшихся дней текущей подписки
- Рассчитывается дневная стоимость текущего тарифа (цена / 30)
- Скидка = дневная стоимость × количество оставшихся дней
- Итоговая цена = цена нового тарифа - скидка (минимум 0)

### Отображение информации о скидке:
- При создании платежа пользователь видит:
  - Переход между тарифами
  - Количество оставшихся дней
  - Полную стоимость
  - Размер скидки
  - Итоговую сумму к оплате
- Администратор получает уведомление с деталями скидки

## Критические моменты

### 1. Обработка ObjectId и populated объектов
**Проблема**: `user.tariffId` после populate является объектом Tariff, не строкой ObjectId.

**Решение**: 
- При сравнении тарифов использовать `currentTariff._id.toString()`
- При доступе к свойствам тарифа использовать объект напрямую

### 2. Redis кеширование
- Токены пользователей кешируются в Redis
- При изменении тарифа кеш очищается
- Формат ключа: преобразованный через ApiKey токен

### 3. Обработка дат
- Используется библиотека Luxon для работы с датами
- Подписка активируется с начала текущего дня
- Истекает в конец дня последнего месяца подписки

## Потенциальные проблемы и рекомендации

### Выявленные проблемы:
1. ✅ **Исправлено**: Ошибка преобразования ObjectId при обращении к populated полям
2. ✅ **Исправлено**: Использование устаревшего InjectRedis декоратора

### Рекомендации по улучшению:

1. **Типизация**: Добавить строгую типизацию для populated полей:
   ```typescript
   interface PopulatedUser extends User {
     tariffId: Tariff;
   }
   ```

2. **Обработка ошибок**: Добавить более детальную обработку ошибок при расчете скидок

3. **Логирование**: Добавить логирование всех этапов обработки платежа для аудита

4. **Валидация**: Добавить валидацию входных данных перед созданием платежа

5. **Тестирование**: Создать unit и интеграционные тесты для:
   - Расчета скидок
   - Обработки различных статусов платежей
   - Переходов между тарифами

## Заключение

Система оплаты работает корректно с учетом внесенных исправлений. Основная логика:
1. При смене тарифа применяется скидка за неиспользованные дни
2. Новый тариф активируется немедленно после оплаты
3. Все платежные системы работают через единый интерфейс стратегии
4. Фоновые задачи обеспечивают автоматическую обработку платежей и истекших подписок

Система готова к использованию после исправления проблем с ObjectId.