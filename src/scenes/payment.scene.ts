import { Action, Ctx, Scene, SceneEnter } from 'nestjs-telegraf';

import { AbstractScene } from '../abstract/abstract.scene';
import { CommandEnum } from '../enum/command.enum';
import { PaymentService } from '../payment/payment.service';
import { PaymentSystemEnum } from 'src/payment/enum/payment-system.enum';
import { Context } from 'src/interfaces/context.interface';
import { Markup } from 'telegraf';
import { replyOrEdit } from 'src/utils/reply-or-edit.util';
import { SCENES } from 'src/constants/scenes.const';

@Scene(CommandEnum.PAYMENT)
export class PaymentScene extends AbstractScene {
  constructor(private readonly paymentService: PaymentService) {
    super();
  }

  @SceneEnter()
  async onSceneEnter(@Ctx() ctx: Context) {
    this.logger.log(ctx.scene.session.current);
    const scene = SCENES[ctx.scene.session.current];

    await replyOrEdit(ctx, scene.text, Markup.inlineKeyboard(scene.buttons));
  }

  @Action(CommandEnum.PAY_WITH_CRYPTOMUS)
  async payWithCriptomus(@Ctx() ctx: Context) {
    const { paymentMonths, tariffId } = ctx.session;

    const paymentSystem = PaymentSystemEnum.CYPTOMUS;

    const payment = await this.paymentService.createPayment(
      ctx.from.id,
      ctx.chat.id,
      tariffId,
      paymentSystem,
      paymentMonths,
    );
    await replyOrEdit(
      ctx,
      `–ß—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∞–º–∏ —Ç–∞—Ä–∏—Ñ–∞, –≤–∞–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.\n\n–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –≤—ã –æ–ø–ª–∞—Ç–∏—Ç–µ, —è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∞–º –ø–æ–º–µ–Ω—è—é —Ç–∞—Ä–∏—Ñ.`,
      Markup.inlineKeyboard([[Markup.button.url('üëâ –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ', payment.url)]]),
    );
  }

  @Action(CommandEnum.PAY_WITH_YOOMONEY)
  async payWithYooMoney(@Ctx() ctx: Context) {
    const { paymentMonths, tariffId } = ctx.session;

    const paymentSystem = PaymentSystemEnum.YOOMONEY;

    const payment = await this.paymentService.createPayment(
      ctx.from.id,
      ctx.chat.id,
      tariffId,
      paymentSystem,
      paymentMonths,
    );
    await replyOrEdit(
      ctx,
      `–ß—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∞–º–∏ —Ç–∞—Ä–∏—Ñ–∞, –≤–∞–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.\n\n–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –≤—ã –æ–ø–ª–∞—Ç–∏—Ç–µ, —è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∞–º –ø–æ–º–µ–Ω—è—é —Ç–∞—Ä–∏—Ñ.`,
      Markup.inlineKeyboard([[Markup.button.url('üëâ –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ', payment.url)]]),
    );
  }
}
