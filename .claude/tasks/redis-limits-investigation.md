# –ó–∞–¥–∞—á–∞: –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å–±—Ä–æ—Å–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ Redis

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ª–∏–º–∏—Ç—ã –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è —Å "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ 11, –æ—Å—Ç–∞–ª–æ—Å—å 2489" –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ 0, –æ—Å—Ç–∞–ª–æ—Å—å 2500".

## –¶–µ–ª—å
–ù–∞–π—Ç–∏ –≤—Å–µ –º–µ—Å—Ç–∞ –≤ –∫–æ–¥–µ –≥–¥–µ –º–æ–≥—É—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è –∏–ª–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –ª–∏–º–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ Redis.

## –ü—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
1. ‚úÖ –ü–æ–∏—Å–∫ –≤—Å–µ—Ö Redis –æ–ø–µ—Ä–∞—Ü–∏–π —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –ª–∏–º–∏—Ç–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. ‚úÖ –ü–æ–∏—Å–∫ cron job'–æ–≤ –∏ scheduled –∑–∞–¥–∞—á –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ –ª–∏–º–∏—Ç—ã 
3. ‚úÖ –ü–æ–∏—Å–∫ –º–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. ‚úÖ –ü–æ–∏—Å–∫ –º–µ—Å—Ç –¥–µ–∫—Ä–µ–º–µ–Ω—Ç–∞ –ª–∏–º–∏—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ API
5. üîÑ –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞

## –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### 1. –ú–µ—Å—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–∏–º–∏—Ç–æ–≤ –≤ Redis (redis.set)

#### –í telegram-bot:
- `/mnt/d/kinopoisk/telegram-bot/src/cache/cache-reset.service.ts:44` - `resetUserCacheAndLimits()` - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π –ª–∏–º–∏—Ç –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ç–∞—Ä–∏—Ñ–∞
- `/mnt/d/kinopoisk/telegram-bot/src/cache/cache-reset.service.ts:130` - `setUserLimit()` - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–∏–º–∏—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/mnt/d/kinopoisk/telegram-bot/src/cache/cache-reset.service.ts:190` - `transferTokenLimits()` - –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –ª–∏–º–∏—Ç –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–æ–∫–µ–Ω–∞

#### –í kinopoiskdev API:
- `/mnt/d/kinopoisk/kinopoiskdev/src/auth/auth.service.ts:63` - `setLimit()` - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–∏–º–∏—Ç –∏–∑ —Ç–∞—Ä–∏—Ñ–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 2. –ú–µ—Å—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ –≤ Redis (redis.del)

#### –í telegram-bot:
- `/mnt/d/kinopoisk/telegram-bot/src/cache/cache-reset.service.ts:39` - –£–¥–∞–ª—è–µ—Ç –∫—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/mnt/d/kinopoisk/telegram-bot/src/cache/cache-reset.service.ts:74,79,114` - –£–¥–∞–ª—è–µ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∫—ç—à–∞
- `/mnt/d/kinopoisk/telegram-bot/src/cache/cache-reset.service.ts:188` - –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–π apiKey –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –ª–∏–º–∏—Ç–æ–≤
- `/mnt/d/kinopoisk/telegram-bot/src/payment/payment.service.ts:202` - **–ö–†–ò–¢–ò–ß–ù–û!** –£–¥–∞–ª—è–µ—Ç –ª–∏–º–∏—Ç—ã –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ

#### –í kinopoiskdev API:
- `/mnt/d/kinopoisk/kinopoiskdev/src/user/user.service.ts:29` - **–ö–†–ò–¢–ò–ß–ù–û!** –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π cron job —É–¥–∞–ª—è–µ—Ç –í–°–ï –ª–∏–º–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `/mnt/d/kinopoisk/kinopoiskdev/src/auth/services/user-cache.service.ts:24,54` - –£–¥–∞–ª—è–µ—Ç –∫—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 3. CRON Jobs –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –ª–∏–º–∏—Ç—ã

#### ‚ö†Ô∏è –û–°–ù–û–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:
- `/mnt/d/kinopoisk/kinopoiskdev/src/user/user.service.ts:21-32` - **–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å —É–¥–∞–ª—è–µ—Ç –í–°–ï –ª–∏–º–∏—Ç—ã –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!**
```typescript
@Cron(CronExpression.EVERY_DAY_AT_MIDNIGHT)
async resetRequestsUsedAndCache() {
  this.logger.log('Start: Reset requests used & cache');
  const cursor = this.userRepository.find({}).cursor();
  for await (const user of cursor) {
    const key = ApiKey.toAPIKey(user.token);
    await this.redis.del(key); // ‚Üê –ó–î–ï–°–¨ –£–î–ê–õ–Ø–Æ–¢–°–Ø –í–°–ï –õ–ò–ú–ò–¢–´!
  }
  this.logger.log('Finish: Reset requests used & cache');
}
```

#### –î—Ä—É–≥–∏–µ cron jobs:
- `/mnt/d/kinopoisk/telegram-bot/src/payment/payment.scheduler.ts:24` - –ö–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–ª–∞—Ç–µ–∂–∏
- `/mnt/d/kinopoisk/telegram-bot/src/payment/payment.scheduler.ts:105` - –ö–∞–∂–¥—ã–µ 5 —á–∞—Å–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
- `/mnt/d/kinopoisk/telegram-bot/src/bot.service.ts:159` - –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 4. –ú–µ—Å—Ç–∞ –¥–µ–∫—Ä–µ–º–µ–Ω—Ç–∞ –ª–∏–º–∏—Ç–æ–≤ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤)

#### –í kinopoiskdev API:
- `/mnt/d/kinopoisk/kinopoiskdev/src/auth/auth.service.ts:52` - `checkAndDecreaseLimit()` –¥–µ–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç –ª–∏–º–∏—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º API –∑–∞–ø—Ä–æ—Å–µ
- `/mnt/d/kinopoisk/kinopoiskdev/src/auth/middleware/auth.middleware.ts:37` - Middleware –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –ª–∏–º–∏—Ç–æ–≤

### 5. –ú–µ—Å—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–æ–≤

#### –í telegram-bot:
- `/mnt/d/kinopoisk/telegram-bot/src/payment/payment.service.ts:249-261` - –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∞—Ä–∏—Ñ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ª–∏–º–∏—Ç—ã
- `/mnt/d/kinopoisk/telegram-bot/src/payment/payment.scheduler.ts:127-132` - –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –Ω–∞ FREE —Ç–∞—Ä–∏—Ñ

## –í–´–í–û–î –û –ü–†–ò–ß–ò–ù–ï –ü–†–û–ë–õ–ï–ú–´

**–ì–ª–∞–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ —Å–±—Ä–æ—Å–∞ –ª–∏–º–∏—Ç–æ–≤:** –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π cron job –≤ `/mnt/d/kinopoisk/kinopoiskdev/src/user/user.service.ts` –∫–∞–∂–¥—É—é –ø–æ–ª–Ω–æ—á—å —É–¥–∞–ª—è–µ—Ç –í–°–ï –ª–∏–º–∏—Ç—ã –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Redis. 

–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞, –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ –∫ API:
1. `auth.service.ts:43` - –ü–æ–ª—É—á–∞–µ—Ç `null` –∏–∑ Redis 
2. `auth.service.ts:46` - –í—ã–∑—ã–≤–∞–µ—Ç `setLimit()` 
3. `auth.service.ts:63` - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ª–∏–º–∏—Ç –∏–∑ —Ç–∞—Ä–∏—Ñ–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç –ø–æ—á–µ–º—É –ª–∏–º–∏—Ç—ã —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è —Å "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ 11, –æ—Å—Ç–∞–ª–æ—Å—å 2489" –Ω–∞ "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ 0, –æ—Å—Ç–∞–ª–æ—Å—å 2500" - –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–±—Ä–æ—Å –≤ –ø–æ–ª–Ω–æ—á—å.

## –°—Ç–∞—Ç—É—Å
‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ - –Ω–∞–π–¥–µ–Ω–∞ –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã